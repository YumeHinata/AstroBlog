---
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");

  // 只为有 legacyHash 的文章生成旧路径
  return posts
    .filter(p => p.data.legacyHash)
    .map(p => ({
      params: { slug: p.data.legacyHash } // ✅ 原样输出，大小写不变
    }));
}

const { slug } = Astro.params;
const hash = Array.isArray(slug) ? slug.join("/") : slug;

const posts = await getCollection("posts");

// ✅ 严格大小写匹配
const target = posts.find(p => p.data.legacyHash === hash);

const targetUrl = target ? `/posts/${target.slug}/` : null;
---

<html lang="zh-CN">
<head>
  <meta charset="utf-8" />

  {targetUrl && <link rel="canonical" href={targetUrl} />}
  {targetUrl && <meta http-equiv="refresh" content={`0;url=${targetUrl}`} />}

  <title>{target ? "内容已迁移" : "页面不存在"} - 跳转中</title>

  <meta name="robots" content="index,follow" />
  <meta name="description" content="页面已迁移，正在跳转到新地址" />

  <style>
    html,body{
      margin:0;
      padding:0;
      height:100%;
      background: radial-gradient(1200px 600px at 50% 0%, #1a1f3a 0%, #0b0d14 40%, #08090f 100%);
      color:#eaeaff;
      font-family: system-ui,-apple-system,BlinkMacSystemFont;
    }
    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:24px;
    }
    .card{
      background:rgba(255,255,255,0.06);
      backdrop-filter: blur(14px);
      padding:52px 56px;
      border-radius:24px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.08),
        0 20px 60px rgba(0,0,0,.45);
      max-width:520px;
      width:100%;
      animation: fadeIn .6s ease;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(12px)}
      to{opacity:1; transform:none}
    }
    .loader{
      width:52px;
      height:52px;
      border:3px solid rgba(255,255,255,.15);
      border-top:3px solid #7aa2ff;
      border-radius:50%;
      animation: spin 1s linear infinite;
      margin:0 auto 28px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    h1{
      font-size:20px;
      margin-bottom:10px;
      font-weight:600;
      letter-spacing:.5px;
    }
    p{
      opacity:.75;
      font-size:14px;
      line-height:1.7;
      margin:0;
    }
    .link{
      display:inline-block;
      margin-top:14px;
      padding:10px 18px;
      border-radius:999px;
      background:rgba(122,162,255,.15);
      color:#7aa2ff;
      text-decoration:none;
      font-size:13px;
      transition:.2s;
    }
    .link:hover{
      background:rgba(122,162,255,.25);
      transform:translateY(-1px);
    }
  </style>

  {targetUrl && (
    <script>
      // 双保险跳转（搜索引擎 + 浏览器）
      setTimeout(() => {
        location.replace("{targetUrl}");
      }, 80);
    </script>
  )}
</head>

<body>
  <div class="wrap">
    <div class="card">

      {targetUrl ? (
        <>
          <div class="loader"></div>
          <h1>内容已迁移</h1>
          <p>该文章已迁移至新地址</p>
          <p>正在为您自动跳转…</p>

          <a class="link" href={targetUrl}>手动前往新页面</a>
        </>
      ) : (
        <>
          <h1>页面不存在</h1>
          <p>该旧链接可能已失效或内容已被移除</p>
          <a class="link" href="/">返回首页</a>
        </>
      )}

    </div>
  </div>
</body>
</html>
